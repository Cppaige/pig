<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>生猪实例分割标注</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Space+Grotesk:wght@500;700&display=swap');

        :root {
            --bg: #f2f0e7;
            --ink: #1f2328;
            --muted: #6b6f76;
            --brand: #2b8a78;
            --brand-2: #f2a65a;
            --card: #ffffff;
            --stroke: #e4e2d8;
            --shadow: 0 18px 45px rgba(29, 41, 57, 0.12);
        }

        body {
            font-family: "Noto Sans SC", "PingFang SC", "Microsoft YaHei", sans-serif;
            background: radial-gradient(circle at 10% 20%, rgba(242, 166, 90, 0.18), transparent 45%),
                        radial-gradient(circle at 90% 10%, rgba(43, 138, 120, 0.18), transparent 40%),
                        var(--bg);
            color: var(--ink);
            min-height: 100vh;
        }

        .hero {
            padding: 3.5rem 0 2.5rem;
        }

        .hero-title {
            font-family: "Space Grotesk", "Noto Sans SC", sans-serif;
            font-weight: 700;
            font-size: clamp(2.4rem, 4vw, 3.4rem);
            letter-spacing: 0.5px;
        }

        .hero-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            border: 1px solid var(--stroke);
            border-radius: 18px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.3rem 0.8rem;
            border-radius: 999px;
            background: rgba(43, 138, 120, 0.12);
            color: var(--brand);
            font-weight: 600;
            font-size: 0.85rem;
        }

        .panel {
            background: var(--card);
            border-radius: 18px;
            border: 1px solid var(--stroke);
            box-shadow: var(--shadow);
            padding: 1.5rem;
        }

        .upload-area {
            border: 2px dashed rgba(43, 138, 120, 0.4);
            border-radius: 16px;
            padding: 2.5rem 1.5rem;
            text-align: center;
            background: #fffdf8;
            transition: 0.25s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: var(--brand);
            background: #fff7ec;
        }

        .upload-area.dragover {
            border-color: var(--brand-2);
            background: rgba(242, 166, 90, 0.15);
        }

        .btn-brand {
            background: var(--brand);
            border: none;
            color: #fff;
            padding: 0.7rem 1.4rem;
            border-radius: 12px;
            font-weight: 600;
        }

        .btn-ghost {
            background: transparent;
            border: 1px solid var(--stroke);
            color: var(--ink);
            padding: 0.7rem 1.4rem;
            border-radius: 12px;
            font-weight: 600;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.8rem;
        }

        .stat-box {
            background: #f9f7ef;
            border-radius: 14px;
            padding: 0.85rem 1rem;
            border: 1px solid var(--stroke);
        }

        .stat-title {
            font-size: 0.75rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--muted);
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: 700;
            margin-top: 0.2rem;
        }

        .result-card {
            background: #fff;
            border-radius: 16px;
            border: 1px solid var(--stroke);
            box-shadow: var(--shadow);
            padding: 1.2rem;
            margin-bottom: 1rem;
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
        }

        .image-card {
            border-radius: 14px;
            overflow: hidden;
            border: 1px solid var(--stroke);
            background: #fffdf8;
        }

        .image-card img {
            width: 100%;
            height: auto;
            display: block;
        }

        .badge-pill {
            background: rgba(43, 138, 120, 0.12);
            color: var(--brand);
            border-radius: 999px;
            padding: 0.25rem 0.7rem;
            font-weight: 600;
            font-size: 0.85rem;
            margin-right: 0.4rem;
        }

        .class-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 1.5rem 0;
        }

        .loading.active {
            display: block;
        }

        .progress {
            height: 14px;
            border-radius: 999px;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, var(--brand), var(--brand-2));
        }

        .muted {
            color: var(--muted);
        }

        @media (max-width: 768px) {
            .hero {
                padding-top: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container hero">
        <div class="row align-items-center gy-4">
            <div class="col-lg-7">
                <div class="d-flex align-items-center gap-2 mb-3">
                    <span class="chip"><i class="fa-solid fa-seedling"></i> YOLOv11 实例分割</span>
                    <a href="/history" class="btn-ghost" style="padding: 0.3rem 0.8rem; border-radius: 999px; font-size: 0.85rem;">
                        <i class="fa-solid fa-clock-rotate-left"></i> 历史记录
                    </a>
                </div>
                <h1 class="hero-title mt-3">猪 & 人 智能实例分割标注</h1>
                <p class="muted mt-3">支持 COCO segmentation 数据，自动生成 mask 并叠加可视化。上传图片即可得到实例分割结果与 JSON 标注。</p>
            </div>
            <div class="col-lg-5">
                <div class="hero-card">
                    <h5 class="mb-3">流程提示</h5>
                    <div class="d-grid gap-2">
                        <div class="stat-box">
                            <div class="stat-title">STEP 1</div>
                            <div class="stat-value">上传图片</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-title">STEP 2</div>
                            <div class="stat-value">模型推理与分割</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-title">STEP 3</div>
                            <div class="stat-value">查看结果与 JSON</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container pb-5">
        <div class="row gy-4">
            <div class="col-lg-6">
                <div class="panel">
                    <h4 class="mb-3"><i class="fa-solid fa-cloud-arrow-up"></i> 上传文件</h4>

                    <!-- 上传类型切换 -->
                    <div class="d-flex gap-2 mb-3">
                        <button class="btn-brand" id="imageTabBtn" onclick="switchUploadType('image')">
                            <i class="fa-regular fa-image"></i> 图片
                        </button>
                        <button class="btn-ghost" id="videoTabBtn" onclick="switchUploadType('video')">
                            <i class="fa-solid fa-video"></i> 视频
                        </button>
                    </div>

                    <!-- 图片上传区域 -->
                    <div id="imageUploadArea">
                        <div id="uploadArea" class="upload-area">
                            <i class="fa-solid fa-cloud-arrow-up fa-3x mb-3" style="color: var(--brand);"></i>
                            <h5>拖拽图片到此处</h5>
                            <p class="muted">支持 PNG / JPG / JPEG / BMP / GIF</p>
                            <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
                            <button class="btn-brand mt-3" onclick="document.getElementById('fileInput').click()">
                                <i class="fa-solid fa-folder-open"></i> 选择图片
                            </button>
                        </div>
                    </div>

                    <!-- 视频上传区域（默认隐藏） -->
                    <div id="videoUploadArea" style="display: none;">
                        <div id="videoUploadDropArea" class="upload-area">
                            <i class="fa-solid fa-film fa-3x mb-3" style="color: var(--brand-2);"></i>
                            <h5>拖拽视频到此处</h5>
                            <p class="muted">支持 MP4 / AVI / MOV / MKV / FLV</p>
                            <p class="muted" style="font-size: 0.8rem;">最大 500MB</p>
                            <p class="muted" style="font-size: 0.8rem;">
                                <i class="fa-solid fa-info-circle"></i> 视频将被转换为标注后的图片序列
                            </p>

                            <!-- 检测参数设置 -->
                            <div style="margin-top: 1rem; padding: 1rem; background: #f9f7ef; border-radius: 10px;">
                                <h6 style="font-size: 0.9rem; margin-bottom: 0.5rem;">检测设置</h6>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <label style="font-size: 0.8rem;">采样间隔（帧）</label>
                                        <select id="frameSkip" class="form-control form-control-sm" style="font-size: 0.85rem;">
                                            <option value="1">每帧检测（最准确）</option>
                                            <option value="5" selected>每 5 帧（推荐）</option>
                                            <option value="10">每 10 帧（快速）</option>
                                            <option value="25">每 25 帧（超快）</option>
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <label style="font-size: 0.8rem;">置信度阈值</label>
                                        <select id="confThreshold" class="form-control form-control-sm" style="font-size: 0.85rem;">
                                            <option value="0.15">低 (0.15) - 检测更多</option>
                                            <option value="0.25" selected>中 (0.25) - 平衡</option>
                                            <option value="0.40">高 (0.40) - 减少误检</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-check mt-2" style="font-size: 0.85rem;">
                                    <input class="form-check-input" type="checkbox" id="enableDedup" checked>
                                    <label class="form-check-label" for="enableDedup">
                                        启用跨帧去重（避免重复计数）
                                    </label>
                                </div>
                            </div>

                            <input type="file" id="videoFileInput" accept="video/*" style="display: none;">
                            <button class="btn-brand mt-3" onclick="document.getElementById('videoFileInput').click()"
                                    style="background: var(--brand-2);">
                                <i class="fa-solid fa-folder-open"></i> 选择视频
                            </button>
                        </div>

                        <div id="videoPreview" style="display: none; margin-top: 1rem;">
                            <div class="result-card">
                                <h6><i class="fa-solid fa-video"></i> 视频预览</h6>
                                <video id="videoPlayer" controls style="width: 100%; max-height: 300px; border-radius: 10px;"></video>
                                <p class="muted mt-2 mb-0" id="videoFileName"></p>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex gap-2 mt-3">
                        <button class="btn-brand w-100" onclick="uploadFiles()" id="uploadBtn">
                            <i class="fa-solid fa-paper-plane"></i> 开始分割
                        </button>
                        <button class="btn-ghost w-100" onclick="clearUploads()">
                            <i class="fa-solid fa-trash"></i> 清空
                        </button>
                    </div>

                    <div class="loading" id="loading">
                        <div class="spinner-border" role="status" style="color: var(--brand);"></div>
                        <p class="mt-2 muted" id="currentFile">正在推理，请稍候…</p>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated"
                                 id="progressBar"
                                 style="width: 0%"
                                 role="progressbar"
                                 aria-valuenow="0"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                                <span id="progressText">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="panel">
                    <h4 class="mb-3"><i class="fa-solid fa-sliders"></i> 推理说明</h4>
                    <p class="muted">默认会叠加实例 mask，并输出 COCO 风格 JSON。你可通过环境变量调整阈值。</p>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-title">CONF_THRESHOLD</div>
                            <div class="stat-value">0.25</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-title">IOU_THRESHOLD</div>
                            <div class="stat-value">0.70</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-title">MODEL_PATH</div>
                            <div class="stat-value">weights/best.pt</div>
                        </div>
                    </div>
                    <p class="muted mt-3">实际运行时会读取系统环境变量，详情请看 README。</p>
                </div>
            </div>
        </div>

        <div class="panel mt-4">
            <h4 class="mb-3"><i class="fa-solid fa-layer-group"></i> 结果展示</h4>
            <div id="resultsContainer"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
        let selectedFiles = [];
        let selectedVideoFile = null;
        let currentUploadType = 'image'; // 'image' or 'video'

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const videoUploadDropArea = document.getElementById('videoUploadDropArea');
        const videoFileInput = document.getElementById('videoFileInput');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        // 视频拖拽事件
        videoUploadDropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            videoUploadDropArea.classList.add('dragover');
        });

        videoUploadDropArea.addEventListener('dragleave', () => {
            videoUploadDropArea.classList.remove('dragover');
        });

        videoUploadDropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            videoUploadDropArea.classList.remove('dragover');
            handleVideoFile(e.dataTransfer.files[0]);
        });

        videoFileInput.addEventListener('change', (e) => {
            handleVideoFile(e.target.files[0]);
        });

        // 切换上传类型
        function switchUploadType(type) {
            currentUploadType = type;
            const imageTabBtn = document.getElementById('imageTabBtn');
            const videoTabBtn = document.getElementById('videoTabBtn');
            const imageUploadArea = document.getElementById('imageUploadArea');
            const videoUploadArea = document.getElementById('videoUploadArea');

            if (type === 'image') {
                imageTabBtn.className = 'btn-brand';
                videoTabBtn.className = 'btn-ghost';
                imageUploadArea.style.display = 'block';
                videoUploadArea.style.display = 'none';
                selectedVideoFile = null;
            } else {
                imageTabBtn.className = 'btn-ghost';
                videoTabBtn.className = 'btn-brand';
                imageUploadArea.style.display = 'none';
                videoUploadArea.style.display = 'block';
                selectedFiles = [];
                updateFileList();
            }
        }

        // 处理视频文件
        function handleVideoFile(file) {
            if (!file) return;

            // 检查文件大小
            if (file.size > 500 * 1024 * 1024) {
                alert('视频文件过大，最大支持 500MB');
                return;
            }

            selectedVideoFile = file;

            // 显示视频预览
            const videoPreview = document.getElementById('videoPreview');
            const videoPlayer = document.getElementById('videoPlayer');
            const videoFileName = document.getElementById('videoFileName');

            videoPreview.style.display = 'block';
            videoFileName.textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;

            // 创建视频预览 URL
            const videoURL = URL.createObjectURL(file);
            videoPlayer.src = videoURL;
        }

        function handleFiles(files) {
            selectedFiles = Array.from(files);
            updateFileList();
        }

        function updateFileList() {
            const container = document.getElementById('resultsContainer');
            if (selectedFiles.length === 0) {
                container.innerHTML = `
                    <div class="text-center muted py-4">
                        <i class="fa-regular fa-images fa-2x mb-2"></i>
                        <p class="mb-0">暂无图片，先上传再开始分割。</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="mb-3">
                    <span class="badge-pill"><i class="fa-solid fa-paperclip"></i> 已选择 ${selectedFiles.length} 张图片</span>
                </div>
            `;

            selectedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imgElement = document.getElementById(`preview-${index}`);
                    if (imgElement) {
                        imgElement.src = e.target.result;
                    }
                };
                reader.readAsDataURL(file);

                html += `
                    <div class="result-card">
                        <div class="image-grid">
                            <div class="image-card">
                                <img id="preview-${index}" src="" alt="预览">
                            </div>
                            <div>
                                <h6 class="mb-2">${file.name}</h6>
                                <p class="muted mb-1">大小：${(file.size / 1024).toFixed(2)} KB</p>
                                <span class="badge-pill">待处理</span>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function uploadFiles() {
            // 根据上传类型选择处理方式
            if (currentUploadType === 'video') {
                uploadVideo();
            } else {
                uploadImages();
            }
        }

        function uploadImages() {
            if (selectedFiles.length === 0) {
                alert('请先选择图片');
                return;
            }

            const loading = document.getElementById('loading');
            const uploadBtn = document.getElementById('uploadBtn');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const currentFileText = document.getElementById('currentFile');

            loading.classList.add('active');
            uploadBtn.disabled = true;

            // 重置进度条
            progressBar.style.width = '0%';
            progressBar.setAttribute('aria-valuenow', '0');
            progressText.textContent = '0%';
            if (currentFileText) {
                currentFileText.textContent = '准备中...';
            }

            // 使用 FormData 和 SSE
            const formData = new FormData();
            selectedFiles.forEach(file => {
                formData.append('files[]', file);
            });

            // 发送请求并建立 SSE 连接
            fetch('/batch_upload_stream', {
                method: 'POST',
                body: formData
            }).then(response => {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                function readStream() {
                    reader.read().then(({ done, value }) => {
                        if (done) {
                            // 流结束
                            loading.classList.remove('active');
                            uploadBtn.disabled = false;
                            return;
                        }

                        // 解析 SSE 数据
                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split('\n');

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.substring(6));

                                    if (data.type === 'progress') {
                                        // 更新进度
                                        progressBar.style.width = `${data.percentage}%`;
                                        progressBar.setAttribute('aria-valuenow', data.percentage);
                                        progressText.textContent = `${data.percentage}%`;

                                        if (currentFileText) {
                                            currentFileText.textContent = `处理中 (${data.current}/${data.total}): ${data.filename}`;
                                        }
                                    } else if (data.type === 'complete') {
                                        // 处理完成
                                        progressBar.style.width = '100%';
                                        progressBar.setAttribute('aria-valuenow', '100');
                                        progressText.textContent = '100%';

                                        if (currentFileText) {
                                            currentFileText.textContent = '处理完成！';
                                        }

                                        displayResults(data.results);

                                        setTimeout(() => {
                                            loading.classList.remove('active');
                                            uploadBtn.disabled = false;
                                        }, 500);
                                    }
                                } catch (e) {
                                    console.error('解析SSE数据错误:', e);
                                }
                            }
                        }

                        readStream(); // 继续读取
                    });
                }

                readStream();
            }).catch(error => {
                console.error('上传错误:', error);
                alert('出错：' + error.message);
                loading.classList.remove('active');
                uploadBtn.disabled = false;
            });
        }

        function classCountsHtml(counts) {
            if (!counts || Object.keys(counts).length === 0) {
                return '<span class="muted">暂无类别统计</span>';
            }
            return Object.entries(counts)
                .map(([name, count]) => `<span class="badge-pill">${name}: ${count}</span>`)
                .join('');
        }

        function displayResults(results) {
            let html = `
                <div class="mb-3">
                    <span class="badge-pill"><i class="fa-solid fa-circle-check"></i> 已处理 ${results.length} 张图片</span>
                </div>
            `;

            results.forEach(result => {
                if (result.error) {
                    html += `
                        <div class="result-card">
                            <h6 class="text-danger"><i class="fa-solid fa-triangle-exclamation"></i> ${result.filename}</h6>
                            <p class="text-danger">错误：${result.error}</p>
                        </div>
                    `;
                } else {
                    const stats = result.stats || {};
                    html += `
                        <div class="result-card">
                            <div class="image-grid mb-3">
                                <div class="image-card">
                                    <img src="${result.original}" alt="原图">
                                </div>
                                <div class="image-card">
                                    <img src="${result.annotated}" alt="分割结果">
                                </div>
                                <div>
                                    <h6>${result.filename}</h6>
                                    <div class="stats-grid mt-2">
                                        <div class="stat-box">
                                            <div class="stat-title">目标数量</div>
                                            <div class="stat-value">${result.objects}</div>
                                        </div>
                                        <div class="stat-box">
                                            <div class="stat-title">Mask 数量</div>
                                            <div class="stat-value">${stats.mask_objects ?? 0}</div>
                                        </div>
                                        <div class="stat-box">
                                            <div class="stat-title">总面积</div>
                                            <div class="stat-value">${stats.total_area ?? 0}</div>
                                        </div>
                                    </div>
                                    <div class="class-list mt-3">
                                        ${classCountsHtml(stats.class_counts)}
                                    </div>
                                    <div class="d-flex gap-2 flex-wrap mt-3">
                                        <button class="btn-ghost" onclick="downloadImage('${result.annotated}')">
                                            <i class="fa-solid fa-download"></i> 下载结果图
                                        </button>
                                        <button class="btn-ghost" onclick="downloadJson('${result.annotation_file}')">
                                            <i class="fa-solid fa-file-code"></i> 下载 JSON
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });

            document.getElementById('resultsContainer').innerHTML = html;
        }

        function downloadImage(url) {
            window.open(url, '_blank');
        }

        function downloadJson(url) {
            if (!url) {
                alert('未生成 JSON 文件');
                return;
            }
            window.open(url, '_blank');
        }

        function uploadVideo() {
            if (!selectedVideoFile) {
                alert('请先选择视频文件');
                return;
            }

            const loading = document.getElementById('loading');
            const uploadBtn = document.getElementById('uploadBtn');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const currentFileText = document.getElementById('currentFile');

            loading.classList.add('active');
            uploadBtn.disabled = true;

            // 重置进度条
            progressBar.style.width = '0%';
            progressBar.setAttribute('aria-valuenow', '0');
            progressText.textContent = '0%';
            currentFileText.textContent = '准备处理视频...';

            // 获取检测参数
            const frameSkip = parseInt(document.getElementById('frameSkip').value);
            const confThreshold = parseFloat(document.getElementById('confThreshold').value);
            const enableDedup = document.getElementById('enableDedup').checked;

            // 使用 FormData 和 SSE
            const formData = new FormData();
            formData.append('file', selectedVideoFile);
            formData.append('frame_skip', frameSkip);
            formData.append('conf_threshold', confThreshold);
            formData.append('enable_dedup', enableDedup);

            // 只使用图片序列接口
            const endpoint = '/upload_video_to_images';

            // 发送请求并建立 SSE 连接
            fetch(endpoint, {
                method: 'POST',
                body: formData
            }).then(response => {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                function readStream() {
                    reader.read().then(({ done, value }) => {
                        if (done) {
                            loading.classList.remove('active');
                            uploadBtn.disabled = false;
                            return;
                        }

                        // 解析 SSE 数据
                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split('\n');

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.substring(6));

                                    if (data.type === 'progress') {
                                        // 更新进度
                                        progressBar.style.width = `${data.percentage}%`;
                                        progressBar.setAttribute('aria-valuenow', data.percentage);
                                        progressText.textContent = `${data.percentage}%`;
                                        currentFileText.textContent = data.status;
                                    } else if (data.type === 'complete') {
                                        // 处理完成
                                        progressBar.style.width = '100%';
                                        progressBar.setAttribute('aria-valuenow', '100');
                                        progressText.textContent = '100%';
                                        currentFileText.textContent = '处理完成！';

                                        displayImageSequenceResult(data);

                                        setTimeout(() => {
                                            loading.classList.remove('active');
                                            uploadBtn.disabled = false;
                                        }, 500);
                                    } else if (data.type === 'error') {
                                        alert('处理出错: ' + data.message);
                                        loading.classList.remove('active');
                                        uploadBtn.disabled = false;
                                    }
                                } catch (e) {
                                    console.error('解析SSE数据错误:', e);
                                }
                            }
                        }

                        readStream();
                    });
                }

                readStream();
            }).catch(error => {
                console.error('上传错误:', error);
                alert('出错：' + error.message);
                loading.classList.remove('active');
                uploadBtn.disabled = false;
            });
        }

        function displayVideoResult(data) {
            const container = document.getElementById('resultsContainer');

            const stats = data.stats || {};

            let html = `
                <div class="mb-3">
                    <span class="badge-pill"><i class="fa-solid fa-circle-check"></i> 视频处理完成</span>
                </div>
                <div class="result-card">
                    <h6 class="mb-3"><i class="fa-solid fa-video"></i> 视频检测结果</h6>
                    <div class="image-grid mb-3">
                        <div class="image-card">
                            <h6 class="p-2 mb-0" style="font-size: 0.9rem;">原始视频</h6>
                            <video controls style="width: 100%; max-height: 250px;">
                                <source src="${data.original_video}" type="video/mp4">
                            </video>
                        </div>
                        <div class="image-card">
                            <h6 class="p-2 mb-0" style="font-size: 0.9rem;">检测结果</h6>
                            <video controls style="width: 100%; max-height: 250px;">
                                <source src="${data.annotated_video}" type="video/mp4">
                            </video>
                        </div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-title">总帧数</div>
                            <div class="stat-value">${stats.total_frames || 0}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-title">检测到的猪</div>
                            <div class="stat-value">${stats.total_pigs || 0}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-title">检测到的人</div>
                            <div class="stat-value">${stats.total_persons || 0}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-title">平均猪数/帧</div>
                            <div class="stat-value">${(stats.total_pigs / Math.max(stats.processed_frames, 1)).toFixed(2)}</div>
                        </div>
                    </div>
                    <div class="d-flex gap-2 mt-3">
                        <button class="btn-brand" onclick="downloadVideo('${data.annotated_video}')">
                            <i class="fa-solid fa-download"></i> 下载结果视频
                        </button>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        function downloadVideo(url) {
            window.open(url, '_blank');
        }

        function displayImageSequenceResult(data) {
            const container = document.getElementById('resultsContainer');

            const stats = data.stats || {};

            let imagesHtml = '';
            if (data.images && data.images.length > 0) {
                imagesHtml = '<div class="image-grid" style="margin-top: 1rem;">';
                data.images.forEach((img, idx) => {
                    imagesHtml += `
                        <div class="image-card">
                            <img src="${data.output_dir}/${img}" alt="Frame ${idx + 1}"
                                 onclick="window.open('${data.output_dir}/${img}', '_blank')"
                                 style="cursor: pointer;">
                            <p class="muted mb-0 p-2" style="font-size: 0.75rem;">帧 ${idx + 1}</p>
                        </div>
                    `;
                });
                imagesHtml += '</div>';

                if (data.total_images > 50) {
                    imagesHtml += `
                        <p class="muted mt-2 text-center">
                            显示前 50 张图片，共 ${data.total_images} 张
                            <br>
                            <a href="${data.output_dir}/" target="_blank" class="btn-ghost" style="margin-top: 0.5rem;">
                                <i class="fa-solid fa-folder-open"></i> 查看所有图片
                            </a>
                        </p>
                    `;
                }
            }

            let html = `
                <div class="mb-3">
                    <span class="badge-pill"><i class="fa-solid fa-circle-check"></i> 图片序列生成完成</span>
                </div>
                <div class="result-card">
                    <h6 class="mb-3"><i class="fa-regular fa-images"></i> 视频帧检测结果</h6>

                    <div class="stats-grid mb-3">
                        <div class="stat-box">
                            <div class="stat-title">总帧数</div>
                            <div class="stat-value">${stats.total_frames || 0}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-title">检测到的猪</div>
                            <div class="stat-value">${stats.total_pigs || 0}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-title">检测到的人</div>
                            <div class="stat-value">${stats.total_persons || 0}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-title">平均猪数/帧</div>
                            <div class="stat-value">${(stats.total_pigs / Math.max(stats.processed_frames, 1)).toFixed(2)}</div>
                        </div>
                    </div>

                    ${imagesHtml}

                    <div class="d-flex gap-2 mt-3">
                        <a href="${data.output_dir}/" target="_blank" class="btn-brand">
                            <i class="fa-solid fa-folder-open"></i> 打开图片文件夹
                        </a>
                        <button class="btn-ghost" onclick="alert('可以使用 ffmpeg 命令将图片序列合成视频:\\nffmpeg -framerate ${stats.fps || 25} -i ${data.output_dir}/annotated_frame_%06d.jpg -c:v libx264 -pix_fmt yuv420p output.mp4')">
                            <i class="fa-solid fa-info-circle"></i> 如何合成视频
                        </button>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        function clearUploads() {
            selectedFiles = [];
            selectedVideoFile = null;
            updateFileList();
            document.getElementById('fileInput').value = '';
            document.getElementById('videoFileInput').value = '';

            // 隐藏视频预览
            const videoPreview = document.getElementById('videoPreview');
            if (videoPreview) {
                videoPreview.style.display = 'none';
            }
        }

        updateFileList();
    </script>
</body>
</html>
